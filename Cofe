#include "cy_pdl.h"
#include "cybsp.h"
#include <stdio.h>

#define RTC_ADDR 0x68

cy_stc_scb_i2c_context_t i2c_context;

/* ---------- BCD Conversion ---------- */
uint8_t dec2bcd(uint8_t val)
{
    return ((val / 10) << 4) | (val % 10);
}

uint8_t bcd2dec(uint8_t val)
{
    return ((val >> 4) * 10) + (val & 0x0F);
}

/* ---------- I2C Write ---------- */
uint8_t RTC_Write(uint8_t reg, uint8_t *data, uint8_t len)
{
    uint8_t buffer[8];
    buffer[0] = reg;

    for(int i = 0; i < len; i++)
        buffer[i+1] = data[i];

    return Cy_SCB_I2C_MasterWrite(
                I2C_HW,
                RTC_ADDR,
                buffer,
                len + 1,
                0,
                &i2c_context);
}

/* ---------- I2C Read ---------- */
uint8_t RTC_Read(uint8_t reg, uint8_t *data, uint8_t len)
{
    cy_en_scb_i2c_status_t status;

    status = Cy_SCB_I2C_MasterWrite(
                I2C_HW,
                RTC_ADDR,
                &reg,
                1,
                CY_SCB_I2C_XFER_PENDING,
                &i2c_context);

    if(status != CY_SCB_I2C_SUCCESS)
        return 1;

    status = Cy_SCB_I2C_MasterRead(
                I2C_HW,
                RTC_ADDR,
                data,
                len,
                0,
                &i2c_context);

    return status;
}

int main(void)
{
    cybsp_init();
    __enable_irq();

    Cy_SCB_I2C_Init(I2C_HW, &I2C_HW_config, &i2c_context);
    Cy_SCB_I2C_Enable(I2C_HW);

    uint8_t set_time[3];
    uint8_t read_time[3];
    uint8_t sec, min, hr;

    /* ---- Set Time: 10:45:30 ---- */
    set_time[0] = dec2bcd(30);
    set_time[1] = dec2bcd(45);
    set_time[2] = dec2bcd(10);

    RTC_Write(0x00, set_time, 3);

    while(1)
    {
        RTC_Read(0x00, read_time, 3);

        sec = bcd2dec(read_time[0] & 0x7F);
        min = bcd2dec(read_time[1]);
        hr  = bcd2dec(read_time[2] & 0x3F);

        printf("Time: %02d:%02d:%02d\r\n", hr, min, sec);

        Cy_SysLib_Delay(1000);
    }
}
